name: CI/CD - Production Deploy (Final Full)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push FRONT image
        uses: docker/build-push-action@v4
        with:
          context: ./front
          file: ./front/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_IMAGE_FRONT }}:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_IMAGE_FRONT }}:latest
          cache-to: type=inline
          # Передаем настройки, чтобы фронт стучался по относительному пути /api
          build-args: |
            VITE_API_URL=/api
            REACT_APP_API_URL=/api
            API_URL=/api
            VITE_WS_URL=

      - name: Build & Push BACK image
        uses: docker/build-push-action@v4
        with:
          context: ./back
          file: ./back/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_IMAGE_BACK }}:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_IMAGE_BACK }}:latest
          cache-to: type=inline

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          envs: SUDO_PASS
          script: |
            export SUDO_PASS="${{ secrets.SERVER_PASSWORD }}"
            set -e

            echo "--- 1. Pulling images ---"
            docker pull "${{ secrets.DOCKER_IMAGE_FRONT }}:latest"
            docker pull "${{ secrets.DOCKER_IMAGE_BACK }}:latest"

            echo "--- 2. Cleaning old containers ---"
            docker rm -f nginx-proxy ouroboros-front-container ouroboros-back-container 2>/dev/null || true

            echo "--- 3. Network ---"
            docker network create nginx_network 2>/dev/null || true

            echo "--- 4. Preparing Filesystem ---"
            SSL_DIR="$HOME/nginx_ssl"
            CONF_DIR="$HOME/nginx_conf"
            DATA_DIR="$HOME/app_data"   # Папка для Базы Данных
            MEDIA_DIR="$HOME/app_media" # Папка для Картинок
            
            # Создаем папки для данных и медиа (если их нет)
            mkdir -p "$DATA_DIR" "$MEDIA_DIR"
            
            # ВАЖНО: Даем права 777, чтобы и Docker (внутри), и Nginx могли читать/писать
            echo "$SUDO_PASS" | sudo -S chmod -R 777 "$DATA_DIR" "$MEDIA_DIR"
            
            # Чистим конфиги Nginx (но данные не трогаем!)
            echo "$SUDO_PASS" | sudo -S rm -rf "$SSL_DIR" "$CONF_DIR"
            mkdir -p "$SSL_DIR" "$CONF_DIR"

            echo "Copying SSL certificates..."
            # Копируем проверенные файлы с сервера
            echo "$SUDO_PASS" | sudo -S cp -L /etc/nginx/ssl/mancinella/fullchain.crt "$SSL_DIR/certificate.crt"
            echo "$SUDO_PASS" | sudo -S cp -L /etc/nginx/ssl/mancinella/site.key "$SSL_DIR/certificate.key"
            
            # Исправляем владельца и права (чтобы Docker мог прочитать ключи)
            echo "$SUDO_PASS" | sudo -S chown -R $USER:$USER "$SSL_DIR"
            chmod 644 "$SSL_DIR/certificate.crt"
            chmod 644 "$SSL_DIR/certificate.key"

            echo "--- 5. Starting App Containers ---"
            
            # BACKEND
            # Монтируем:
            # - Базу в /app/data
            # - Медиа в /app/media (сюда сохраняются загрузки)
            docker run -d --name ouroboros-back-container --network nginx_network \
              -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              -e SECRET_KEY="${{ secrets.SECRET_KEY }}" \
              -e ALGORITHM=HS256 \
              -e ACCESS_TOKEN_EXPIRE_MINUTES=43200 \
              -v "$DATA_DIR":/app/data \
              -v "$MEDIA_DIR":/app/media \
              --restart unless-stopped \
              "${{ secrets.DOCKER_IMAGE_BACK }}:latest" \
              uvicorn app.main:app --host 0.0.0.0 --port 8000 --proxy-headers --root-path /api

            # FRONTEND
            docker run -d --name ouroboros-front-container --network nginx_network \
              --restart unless-stopped \
              "${{ secrets.DOCKER_IMAGE_FRONT }}:latest"

            echo "--- 6. Generating Nginx Config ---"
            cat > "$CONF_DIR/nginx.conf" << 'EOL'
            user  nginx;
            worker_processes auto;
            error_log /var/log/nginx/error.log notice;
            pid /var/run/nginx.pid;

            events { worker_connections 1024; }

            http {
                include /etc/nginx/mime.types;
                default_type application/octet-stream;
                
                log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                                '$status $body_bytes_sent "$http_referer" '
                                '"$http_user_agent"';
                access_log /var/log/nginx/access.log main;
                
                sendfile on;
                keepalive_timeout 65;
                client_max_body_size 20M; # Максимальный размер загрузки
                proxy_read_timeout 300s;  # Чтобы вебсокеты не рвались
                proxy_connect_timeout 75s;

                server {
                    listen 80;
                    server_name mancinella.ru www.mancinella.ru;
                    return 301 https://$host$request_uri;
                }

                server {
                    listen 443 ssl default_server;
                    server_name mancinella.ru www.mancinella.ru;

                    ssl_certificate /etc/nginx/ssl/certificate.crt;
                    ssl_certificate_key /etc/nginx/ssl/certificate.key;
                    ssl_protocols TLSv1.2 TLSv1.3;
                    ssl_prefer_server_ciphers on;

                    # --- FIX ДЛЯ ФРОНТЕНДА (МЕДИА) ---
                    # Если фронт добавил /api к картинке, мы всё равно отдаем файл
                    location /api/media/ {
                        alias /var/www/media/;
                        autoindex off;
                        expires 30d;
                        add_header Cache-Control "public, no-transform";
                    }

                    # Нормальный путь для медиа
                    location /media/ {
                        alias /var/www/media/;
                        autoindex off;
                        expires 30d;
                        add_header Cache-Control "public, no-transform";
                    }

                    # API и WEBSOCKETS
                    location /api/ {
                        proxy_pass http://ouroboros-back-container:8000/;
                        
                        # Включаем WebSockets
                        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "upgrade";
                        
                        # Заголовки
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_set_header X-Forwarded-Prefix /api;
                    }

                    # Фронтенд
                    location / {
                        proxy_pass http://ouroboros-front-container:80/;
                        proxy_http_version 1.1;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                    }
                }
            }
            EOL

            echo "Starting Nginx..."
            # Монтируем Медиа папку в Nginx для раздачи статики
            docker run -d --name nginx-proxy --network nginx_network \
              -p 80:80 -p 443:443 \
              -v "$CONF_DIR/nginx.conf":/etc/nginx/nginx.conf:ro \
              -v "$SSL_DIR":/etc/nginx/ssl:ro \
              -v "$MEDIA_DIR":/var/www/media:ro \
              --restart unless-stopped \
              nginx:alpine

            echo "--- 7. Cleanup ---"
            docker image prune -f
            echo "Deployment complete!"
